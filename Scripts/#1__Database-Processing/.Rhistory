####Plots based on Annotation-table####
##Annotation-table.R must be run first before generating plot.
###Feature-Counter.R counts the frequency of annotations (including propagated Ms/MS) across fractions and creates a barchart
# Load necessary libraries
library(dplyr)
library(tidyr)
library(ggplot2)
### Feature and Annotation counter per Sample/Fraction
## This follows up on Annotation-table.R and Cytoscape-tidier.R
# 1. Preparing Annotations.with.samples
Samples <- select(final.annotation.df, feature.ID, Samples, compound.name)  # Extract relevant sample data
#### ANNOTATION TABLE SCRIPT FOR AUSTRALIAN HUMAN GUT METABOLOME DATABASE ####
#!# Run 1-Functions first! #!!#
#------------------------------------------------------------------------------#
###---START OF USER-FED INFORMATION---###
# Dataset ID: From Data Management Plan:
dataset.id <- "HGMD_0070"     #####Change to dataset of interest#####
# Specify the path to the Data Management Plan (unless moved to Mediaflux then should be consistent)
excel_file <- "C:/Users/mcowled/The University of Melbourne/MA Human Gut Metabolome - Documents/Data Management and Analysis/HGM - Data Management System.xlsx"
# Annotation Acceptance Probabilities (Defaults for Exploratory Analyses)
# Increase stringency if the application demands it.
gnps.prob <- 0.7              # Default is 0.7 (and should be changed to those set in run)
canopus.prob <- 0.7           # Default is 0.7
csi.prob <- 0.64            # Default is 0.64 ##10% FDR
ms2query.prob <- 0.63         # Default is 0.63 ##Recommended by paper
# Specify rt tolerance of standards (min)
rt.tol <- 0.1               # Default is 0.1 min for C18 (use 0.2 min for HILIC)
###---END OF USER-FED INFORMATION---###
#------------------------------------------------------------------------------#
## 1. check_and_install
# Function to check, install, and load required packages
check_and_install <- function(packages, github_packages = list()) {
# Install 'remotes' if needed for GitHub installs
if (!requireNamespace("remotes", quietly = TRUE)) {
install.packages("remotes")
}
for (pkg in packages) {
if (!requireNamespace(pkg, quietly = TRUE)) {
if (pkg %in% names(github_packages)) {
message(paste("Installing", pkg, "from GitHub:", github_packages[[pkg]]))
remotes::install_github(github_packages[[pkg]])
} else {
message(paste("Installing", pkg, "from CRAN"))
install.packages(pkg, dependencies = TRUE)
}
}
suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}
}
required_packages <- c("MAPS.Package", "dplyr", "tidyr", "stringr", "readr",
"reshape2", "ggplot2", "svglite", "readxl", "data.table",
"openxlsx", "tidyverse", "rvest", "jsonlite", "xml2")
github_packages <- list("MAPS.Package" = "michael-cowled/MAPS-Package-Public")
check_and_install(required_packages, github_packages)
# --- Load or Initialize Cache ---
cid_cache_file <- "cid_cache.csv"
if (file.exists(cid_cache_file)) {
cid_cache_df <- read.csv(cid_cache_file, stringsAsFactors = FALSE)
} else {
cid_cache_df <- data.frame(
LookupName = character(),
ResolvedName = character(),
SMILES = character(),
CID = numeric(),
MolecularFormula = character(),
MonoisotopicMass = numeric(),
stringsAsFactors = FALSE
)
}
## 2. Updating Metadata and extract gnps task ID                                ----> Remove from published version
sheet_names <- excel_sheets(excel_file) # Get the sheet names
for (sheet in sheet_names) {
data <- read_excel(excel_file, sheet = sheet)
write.csv(data, file = paste0("HGM/", sheet, ".csv"), row.names = FALSE)
}
